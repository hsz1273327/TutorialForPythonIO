# 接口服务

python在很早就已经是一个可以用于开发后端服务的语言,像豆瓣知乎在开始的时候都是使用python写的,历史上也出现过许多广受欢迎的web框架.
而现在微服务架构盛行,python自然不会在这个传统领域落后于人.

## 网络服务系统的结构

网络服务系统的结构并没有一个统一的说法,就我个人总结通常说的web服务又距离客户从近到远包含如下组成:

+ 表现层(前端服务/移动端服务/微信小程序等)

    这一层是业务的表现层,提供人机交互的接口,最显著改变用户体验的部分就在这里,一般由交互设计,平面设计,UI设计,前端/移动端工程师完成,主要的任务是让服务观感体验更好从而促进消费.
    
+ 网关层
    
    这一层直接为表现层服务,一般是聚合内网接口提供外网接口,这层一般比较简单较少改动,通常就是使用nginx做反向代理,一般由运维人员负责管理
    
+ 业务层

    这一层提供业务逻辑,它会根据请求调用下一层的功能服务,一般由后端工程师开发实现.它的主要指标是并发量.
    
+ 功能层

    提供各种功能的专用服务的一层,比如认证服务,比如支付,比如发邮件,比如各种推荐算法等就是一个功能层的服务.一般功能层都是无状态的,可以任意横向扩展,因此并发不是最核心的指标,而单一任务的运行速度才是核心指标,由对特定功能领域熟悉的后端工程师或领域专家实现.
    
+ 数据层

    通常是为功能层中一些服务,表现层和业务层一些后续设计提供数据支持的组件,这些一般不是服务,而是由用于将数据的结构化,清洗,预警,入库,定期分析的脚本组成的一套流程系统.这一层一般是为整个业务服务,产品做用研需要数据,推荐系统做推荐需要数据,数据就是从这边来的.通常这一层处理的是log流.消息队列是基本的数据来源.
    
+ 基础设施层

    这一层一般都是一些有状态服务,像各种数据库,nfs,ELK套件,Docker套件等,还有一些是定制化的监控服务,他们用于承载上面各层的需求,并提供状态监控服务直接为业务本身运行状态负责.这一层通常各大云服务商都会提供,即便没有提供的一般也是直接使用开源软件实现,如果有一些特定的需求需要做定制,一般是由所谓运维开发人员负责设计开发,而维护则是交给运维人员.
    
接下来的部分我们将以这个分层作为前提展开,探讨下python可以在这个分层中扮演什么样的作用

## python在后端开发中的角色

实际上上面的`表现层/网关层/业务层`的分离也不过是最近几年随着移动端的兴起才形成的,在不久之前,所谓的网络服务只有http的web服务一种,也就是做网站.那个年代流行经典的[MVC]架构设计--表现层(view层)直接与业务层中的数据(model层)关联,那个年代流行`jsp`,`.net`,`php`都是这套思想的衍生--一个网站从表现层到业务层都由一个应用实现.而python虽然在这些大佬面前并不占优势,但也有[django](https://www.djangoproject.com/)和[flask](http://docs.jinkan.org/docs/flask/)来支持这种开发模式.本文不对这种类型的技术做过多介绍,感兴趣的可以买本[Flask Web开发：基于Python的Web应用开发实战](http://www.ituring.com.cn/book/1449)看看,这本书全书围绕一个例子对于这种类型的技术做了相当好的介绍,看完这类任务基本就可以自己去做了.

这种模式下由于python原生代码性能差,表现层使用的模板(通常是类似[jinja2](http://blog.hszofficial.site/TutorialForPython/%E8%AF%AD%E6%B3%95%E7%AF%87/%E6%96%87%E6%9C%AC%E4%B8%8E%E5%AD%97%E8%8A%82%E5%BA%8F/%E6%96%87%E6%9C%AC%E6%A8%A1%E6%9D%BF.html#%E4%BD%BF%E7%94%A8jinja2%E5%81%9A%E4%B8%BA%E6%A8%A1%E6%9D%BF)的模板引擎)语法和python本身语法不一致,有额外学习成本,还有全局锁无法利用多核,因此还必须搭配服务器中间件比如[guncorn](https://gunicorn.org/),[uwsgi](https://uwsgi-docs.readthedocs.io/en/latest/),或者通过猴子补丁用[gevent](http://www.gevent.org/)这类协程库替换掉线程库然后执行其独立wsgi容器来进行部署,python老实讲并没有太多优势,也就落一个框架插件多开发迅速可以做快速实现快速迭代了.

在移动端兴起之后,mvc框架渐渐走上了末路,毕竟好不容易开发一套结果要做个一样功能的移动端还有再从头做一遍,这相当浪费人力.之后就出现了前后端分离架构--也就是将`表现层`与`业务层`拆开,业务层也不再管交互逻辑,专注于业务逻辑即可,于是渐渐的业务层代码也以实现通用业务逻辑为主,慢慢去状态甚至不少会被设计为无状态服务,然后业务层代码也被按业务不同进行拆分,不同平台的专用逻辑渐渐交给表现层自己实现.

表现层和业务层之间加上网关层则是为了方便使用同一的入口在两层之间传递消息,同时也可以作为负载均衡的工具.

在前后端分离成为主流,微服务盛行的今天,结合python自身特点,python在服务端的角色更多的是:

+ 快速原型实现业务层接口,通常是RESTful接口或者websocket接口
+ 结合python的在机器学习和科学计算方面的特长提供功能层的RPC服务
+ 在数据层实现各种脚本

本文将介绍

+ RESTful接口服务
+ Websocket服务
+ RPC接口服务

相关的技术有:

+ [aiortc](https://github.com/aiortc/aiortc)一个webrtc的python实现
+ [zmq](http://zeromq.org/)一种跨语言的基于通信模式的消息队列框架